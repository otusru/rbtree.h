### üîß 1. **–£–±–µ—Ä–∏ –ª–∏—à–Ω–∏–µ include'—ã**

–ù–µ–∫–æ—Ç–æ—Ä—ã–µ `#include` –º–æ–≥—É—Ç –±—ã—Ç—å –ª–∏—à–Ω–∏–º–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω–æ–º —Ñ–∞–π–ª–µ. –ù–∞–ø—Ä–∏–º–µ—Ä:

```c
#include <linux/stddef.h>
#include <linux/rcupdate.h>
```

–ï—Å–ª–∏ —Ç–≤–æ–π –º–æ–¥—É–ª—å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `RCU`, –∏–ª–∏ —Ç—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `offsetof` –Ω–∞–ø—Ä—è–º—É—é ‚Äî –º–æ–∂–Ω–æ –∏—Ö –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ `.c` —Ñ–∞–π–ª, –≥–¥–µ –æ–Ω–∏ —Ä–µ–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.

---

### üöÄ 2. **–£–ª—É—á—à–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ `rb_find_add_cached`**

–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç –≤—Å—Ç–∞–≤–∫—É –∏–ª–∏ –ø–æ–∏—Å–∫. –ú–æ–∂–Ω–æ –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Ç–≤–ª–µ–Ω–∏—è –∏ –Ω–µ–º–Ω–æ–≥–æ —É—Å–∫–æ—Ä–∏—Ç—å —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ.

**–ë—ã–ª–æ:**

```c
int c;

while (*link) {
	parent = *link;
	c = cmp(node, parent);

	if (c < 0) {
		link = &parent->rb_left;
	} else if (c > 0) {
		link = &parent->rb_right;
		leftmost = false;
	} else {
		return parent;
	}
}
```

**–°—Ç–∞–ª–æ:**

```c
while (*link) {
	parent = *link;
	int c = cmp(node, parent);

	if (c == 0)
		return parent;

	leftmost &= (c < 0);
	link = (c < 0) ? &parent->rb_left : &parent->rb_right;
}
```

üîπ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `leftmost &= (c < 0)` –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Å–ª–µ–≤–∞/—Å–ø—Ä–∞–≤–∞.

---

### üõ°Ô∏è 3. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ —á–∏—Ç–∞–µ–º–æ—Å—Ç—å —á–µ—Ä–µ–∑ `likely/unlikely`**

–ï—Å–ª–∏ —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å `gcc`/`clang`, –¥–æ–±–∞–≤—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∫–æ–º–ø–∏–ª—è—Ç–æ—Ä—É:

```c
#include <linux/compiler.h>
```

```c
if (unlikely(c == 0))
    return parent;

if (likely(c < 0))
    link = &parent->rb_left;
else
    link = &parent->rb_right;
```

---

### üß† 4. **–£–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ ‚Äî –≤ `rb_find_add` –∏ `rb_add`**

–≠—Ç–∏ –¥–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ—á—Ç–∏ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã. –ú–æ–∂–Ω–æ –æ–±—ä–µ–¥–∏–Ω–∏—Ç—å —á–µ—Ä–µ–∑ inline-—Ö–µ–ª–ø–µ—Ä:

```c
static inline struct rb_node **
rb_search(struct rb_node **link, struct rb_node **parent,
          struct rb_node *node, int (*cmp)(struct rb_node *, const struct rb_node *))
{
    while (*link) {
        *parent = *link;
        int c = cmp(node, *parent);

        if (c < 0)
            link = &(*parent)->rb_left;
        else if (c > 0)
            link = &(*parent)->rb_right;
        else
            return NULL; // found
    }
    return link;
}
```

---

### ‚úÖ 5. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Ä–µ–≤–∞**

–î–æ–±–∞–≤—å —Ö–µ–ª–ø–µ—Ä –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è `rb_root_cached`):

```c
#define RB_ROOT_CACHED (struct rb_root_cached) { .rb_root = RB_ROOT, .rb_leftmost = NULL }
```

---

### üß™ 6. **–ë–µ–Ω—á–º–∞—Ä–∫–∏–Ω–≥ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –ò—Å–ø–æ–ª—å–∑—É–π `perf` –∏–ª–∏ `ftrace` –¥–ª—è –æ—Ü–µ–Ω–∫–∏ —É–∑–∫–∏—Ö –º–µ—Å—Ç. –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è:

* –ò—Å–ø–æ–ª—å–∑—É–π **BPF**/eBPF –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
* –¢–µ—Å—Ç–∏—Ä—É–π —Å –±–æ–ª—å—à–∏–º —á–∏—Å–ª–æ–º —É–∑–ª–æ–≤ –∏ —Å–º–µ—â–µ–Ω–∏–µ–º –≤ –¥–∞–Ω–Ω—ã—Ö.
* –°—Ä–∞–≤–Ω–∏ —Å AVL –∏–ª–∏ Splay –¥–µ—Ä–µ–≤—å—è–º–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∑–∞–¥–∞—á–∏.

---

### üìú –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–≤–æ–π –∫–æ–¥ —É–∂–µ –Ω–∞–ø–∏—Å–∞–Ω –Ω–∞ –Ω–∏–∑–∫–æ–º —É—Ä–æ–≤–Ω–µ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –ú–æ–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∫–∞—Å–∞—é—Ç—Å—è:

* –ë–æ–ª–µ–µ —á–∏—Å—Ç–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã.
* –ú–µ–ª–∫–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π –≤ —Å—Ä–∞–≤–Ω–µ–Ω–∏–∏ –∏ –ª–æ–≥–∏–∫–µ.
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–∞–∫—Ä–æ—Å–æ–≤ (`likely`, `unlikely`, `__always_inline`).

–ï—Å–ª–∏ —É —Ç–µ–±—è –µ—Å—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10 –º–ª–Ω –≤—Å—Ç–∞–≤–æ–∫/–ø–æ–∏—Å–∫–æ–≤, –≤—Å—Ç–∞–≤–∫–∞ –ø–æ timestamp, —Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ —è–¥—Ä–µ), –º–æ–∂–µ—à—å —É–∫–∞–∑–∞—Ç—å, –∏ —è –ø–æ–¥—Å–∫–∞–∂—É –±–æ–ª–µ–µ —Ç–æ—á–µ—á–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –ø–æ–¥ –∑–∞–¥–∞—á—É.

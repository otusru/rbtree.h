## üí° –í–æ–∑–º–æ–∂–Ω—ã–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏ —É–ª—É—á—à–µ–Ω–∏—è

### 1. **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ —Ü–∏–∫–ª–∞—Ö –ø–æ–∏—Å–∫–∞**

–§—É–Ω–∫—Ü–∏–∏ –≤—Ä–æ–¥–µ `rb_find_add()` –∏ `rb_find()` –≤—ã–∑—ã–≤–∞—é—Ç `cmp()` –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø—Ä–æ—Ö–æ–¥–µ —Ü–∏–∫–ª–∞:

```c
c = cmp(node, parent);
if (c < 0) ...
else if (c > 0) ...
```

‚úÖ **–£–ª—É—á—à–µ–Ω–∏–µ:**
–ó–∞–º–µ–Ω–∏—Ç—å `else if (c > 0)` –Ω–∞ `else` –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ (—Ç–∞–∫ –∫–∞–∫ `c == 0` —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω–æ).

```c
if (c < 0)
    link = &parent->rb_left;
else if (c > 0)
    link = &parent->rb_right;
```

‚û°Ô∏è

```c
if (c < 0)
    link = &parent->rb_left;
else if (c > 0)
    link = &parent->rb_right;
else
    return parent;
```

üëâ –•–æ—Ç—è —ç—Ç–æ –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è, –æ–Ω–∞ –ø–æ–º–æ–≥–∞–µ—Ç –≤ "tight loops", –æ—Å–æ–±–µ–Ω–Ω–æ –Ω–∞ –±–æ–ª—å—à–∏—Ö –¥–µ—Ä–µ–≤—å—è—Ö.

---

### 2. **–£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ `rb_add` –∏ `rb_find_add`**

–í —Ñ—É–Ω–∫—Ü–∏–∏ `rb_find_add()` –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–≥–∏–∫–∏ `rb_add`. –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç –≤—Å—Ç–∞–≤–∫—É:

```c
static __always_inline void __rb_insert_node(...)
```

–¢–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ —É–º–µ–Ω—å—à–∏—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —É–ø—Ä–æ—Å—Ç–∏—Ç –ø–æ–¥–¥–µ—Ä–∂–∫—É.

---

### 3. **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏ –¥–æ—Å—Ç—É–ø–∞ —Å —É—á–µ—Ç–æ–º NUMA**

–î–ª—è –º–Ω–æ–≥–æ–ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–Ω—ã—Ö —Å–∏—Å—Ç–µ–º —Å NUMA –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç `rb_add_numa_aware()`, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –ø–æ–¥–¥–µ—Ä–µ–≤—å—è –∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –≤–µ—Ä—à–∏–Ω—ã –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞. –≠—Ç–æ –Ω–µ —Ç—Ä–∏–≤–∏–∞–ª—å–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç –¥–∞—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –≤—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö.

---

### 4. **Prefetching (–∑–∞–±–ª–∞–≥–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö)**

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ `prefetch()` –≤–Ω—É—Ç—Ä–∏ —Ü–∏–∫–ª–∞ –ø–æ–∏—Å–∫–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –¥–µ—Ä–µ–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –≥–æ—Ä—è—á–µ–º –ø—É—Ç–∏ –≤ —Å–µ—Ç–µ–≤–æ–º —Å—Ç–µ–∫–µ –∏–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

```c
prefetch(*link);
```

–ü–µ—Ä–µ–¥ –ø—Ä–æ–≤–µ—Ä–∫–æ–π `while (*link)` –∏–ª–∏ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–∫–∞–∑–∞—Ç–µ–ª—è.

---

### 5. **–ò–Ω–ª–∞–π–Ω–∏–Ω–≥ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `likely()/unlikely()`**

–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `likely()`/`unlikely()` –º–∞–∫—Ä–æ—Å—ã:

```c
if (likely(c < 0)) ...
```

–≠—Ç–æ –¥–∞—Å—Ç –Ω–µ–±–æ–ª—å—à–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –≤ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏, –µ—Å–ª–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑–≤–µ—Å—Ç–Ω–æ –∑–∞—Ä–∞–Ω–µ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–∞—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤–ª–µ–≤–æ).

---

### 6. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø—É—Ç–µ–π**

–ï—Å–ª–∏ –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏—è—Ö —á–∏—Ç–∞–µ—Ç—Å—è –º–Ω–æ–∂–µ—Å—Ç–≤–æ —É–∑–ª–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∫–ª—é—á–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, `rb_for_each()`), –≤–æ–∑–º–æ–∂–Ω–æ –∏–º–µ–µ—Ç —Å–º—ã—Å–ª —Å–æ—Ö—Ä–∞–Ω—è—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–∞–π–¥–µ–Ω–Ω—ã–π —É–∑–µ–ª –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å small LRU –≤–Ω—É—Ç—Ä–∏ –≤—ã–∑—ã–≤–∞—é—â–µ–≥–æ –∫–æ–¥–∞.

---

### 7. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏–ª–∏ —Ö—É–∫–æ–≤**

–î–ª—è –ø—Ä–æ—Ñ–∏–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –æ—Ç–ª–∞–¥–∫–∏ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ –∏—Ç–µ—Ä–∞—Ü–∏–π –∏–ª–∏ —Ö—É–∫–∏ –≤—Å—Ç–∞–≤–∫–∏/—É–¥–∞–ª–µ–Ω–∏—è.

---

## üìâ –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

* **–§—É–Ω–∫—Ü–∏–∏ `rb_add_cached()` –∏ `rb_find_add_cached()`** –º–æ–≥—É—Ç –Ω–µ –¥–∞–≤–∞—Ç—å –ø—Ä–∏—Ä–æ—Å—Ç–∞, –µ—Å–ª–∏ `rb_leftmost` –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –∫ –ø–µ—Ä–≤–æ–º—É —É–∑–ª—É —Ä–µ–¥–∫–∏–π).
* –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `rcu_dereference_raw()` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –±–µ–∑ —è–≤–Ω—ã—Ö –±–∞—Ä—å–µ—Ä–æ–≤ –ø–∞–º—è—Ç–∏ ‚Äî –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –ù–∞ ARM/Power —ç—Ç–æ –≤–∞–∂–Ω–æ.

---

## ‚úÖ –û–±—â–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

| –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è                           | –ü–æ–ª—å–∑–∞                    | –†–∏—Å–∫                   |
| ------------------------------------- | ------------------------- | ---------------------- |
| Prefetch                              | –£—Å–∫–æ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø           | –ú–æ–∂–µ—Ç –∑–∞–º–µ–¥–ª–∏—Ç—å –≤ idle |
| Inline –≤—Å—Ç–∞–≤–∫–∞ —á–µ—Ä–µ–∑ \_\_rb\_insert() | –ú–µ–Ω—å—à–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è       | –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –∫–æ–¥–∞        |
| likely/unlikely                       | –£–ª—É—á—à–∞–µ—Ç –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ     | –ü–ª–∞—Ç—Ñ–æ—Ä–º–µ–Ω–Ω–æ-–∑–∞–≤–∏—Å–∏–º–æ  |
| NUMA-aware –≤—Å—Ç–∞–≤–∫–∞                    | –ü–æ–≤—ã—à–∞–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –°–ª–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å     |
